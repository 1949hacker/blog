---
title: 服务器稳定性及基准测试方法
comments: true
categories: [知识库]
date: 2025-09-11 15:40:24
keywords:
  - 服务器
  - 基准测试
  - 服务器压测
  - Stress-NG
  - Sysbench
  - 内存
  - CPU
  - 硬盘
tags:
  - 服务器
  - 基准测试
  - 服务器压测
  - Stress-NG
  - Sysbench
  - 内存
  - CPU
  - 硬盘
---

## 测试项

### CPU基准和稳定性测试

|测试项|测试工具|参考业务场景|
|---|---|---|
|浮点运算|Linpack|数据分析、大量数值计算、机器学习推理/训练|
|整数运算|sysbench cpu|Redis、Kafka|
|稳定性|Stress-NG|CPU、内存、IO全面压力测试|

### 内存基准和稳定性测试

<!-- more -->

|测试项|测试工具|参考业务场景|
|---|---|---|
|内存带宽|Stream Copy/Scale/Add/Triad|内存数据库（Redis）、大数据处理、Kafka 消息队列、缓存系统|
|压力测试|sysbench memory|压力测试，随机、顺序访问测试|
|稳定性测试|memtester|持续运行数小时,测试稳定性|

### 网络基准测试

|测试项|测试工具|参考业务场景|
|---|---|---|
|带宽极限|iperf3|测试带宽极限性能是否接近理论极限值|
|吞吐测试|netperf TCP_RR / UDP_RR|微服务 RPC、数据库访问、API 调用、Kafka 消息传输|

### 硬盘测试

|测试项|测试工具|参考业务场景|
|---|---|---|
|4k单队列|fio bs=4k iodepth=1|MySQL场景|
|4k 32队列|fio bs=4k iodepth=32|MongoDB场景|
|32k 32队列|fio bs=32k iodepth=32|高并发Web服务，Kafka日志刷盘，多线程缓存写入|
|1m 单队列|fio bs=1m iodepth=1|顺序读写，备份、视频流、镜像分发|
|1m 32队列|fio bs=1m iodepth=32|并发大文件读写，大规模备份，分布式存储，对象存储|

其中针对业务场景，根据单台服务器部署的业务数量适当设置`numjobs`以模拟操作系统/应用层并发。

例如单台服务器4个数据库，则`fio bs=4k iodepth=32 numjobs=4`。

`iodepth`对应单个线程的队列深度，用于存储设备并发能力测试

`numjobs`对应多个线程并发，用于测试操作系统/应用层并发能力

### 综合基准测试

|测试项|测试工具|参考业务场景|
|---|---|---|
|综合性能指数|UnixBench|横向比较整机性能|

## 测试过程

### AMD 9F14平台测试

#### 安装CentOS 7.9.2009

替换源为清华大学CentOS-Vault源

```shell
sed -e "s|^mirrorlist=|#mirrorlist=|g" \
    -e "s|^#baseurl=http://mirror.centos.org/centos/\$releasever|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-vault/7.9.2009|g" \
    -e "s|^#baseurl=http://mirror.centos.org/\$contentdir/\$releasever|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos-vault/7.9.2009|g" \
    -i.bak \
    /etc/yum.repos.d/CentOS-*.repo
```

该命令执行后会将原本的所有源配置文件备份为带`.bak`后缀名的备份

```shell
# 启用bash扩展通配符
shopt -s extglob

# 使用通配符快速删除不带.bak的文件
rm !(*.bak) -f

# 使用for循环快速去掉.bak后缀
for f in *.bak;do mv -- "$f" "${f%.bak}";done
```

`yum makecache`更新源

`yum install vim`安装vim编辑器

```shell
# 更新源
yum makecache
# 安装vim
yum install vim
# 编辑ssh配置文件
vim /etc/ssh/sshd_config
# 设置心跳
# 取消注释，设置为每60秒发送一次心跳重复9999999次
ClientAliveInterval 60
ClientAliveCountMax 99999
# 设置允许root用户登录
# 取消注释并配置为yes
PermitRootLogin yes
# 重启ssh服务
systemctl restart sshd
```

#### 准备CPU的Linpack测试

```shell
# 基础环境
yum install gcc gcc-c++ gcc-gfortran cmake python3 zlib* -y
# 安装OpenBLAS
yum install -y epel-release
yum install -y openblas openblas-devel
# 安装OpenMPI
yum install openmpi openmpi-devel
# 找到MPI的位置
find /usr -name "mpicc" 2>/dev/null
# 我的输出如下
/usr/lib64/openmpi/bin/mpicc
# 添加MPI到环境变量
echo 'export PATH=/usr/lib64/openmpi/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
# 临时生效
export PATH=/usr/lib64/openmpi/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH

# 下载High Performance Linpack
# 去官网检查最新版https://www.netlib.org/benchmark/hpl/
wget https://www.netlib.org/benchmark/hpl/hpl-2.3.tar.gz
tar xvf hpl-2.3.tar.gz
mv hpl-2.3 hpl
mv hpl ~/
cd ~/hpl

# 从模板创建副本并改动编译器参数
# INTEL使用Make.Linux_Intel64
# AMD使用Make.Linux_ATHLON_FBLAS
cp setup/Make.Linux_ATHLON_FBLAS ./Make.AMD_OpenBLAS
vim Make.AMD_OpenBLAS

# 64行的ARCH自定义名称，需要和文件名后缀一致，如Make.AMD_OpenBLAS
# 后续make编译时会用到，如make arch=AMD_OpenBLAS
ARCH = AMD_OpenBLAS

# 配置openblas通用开源方案，保持测试结果的中立
# 避免MKL和AOCL BLIS/LibFLAME对于INTEL AMD的专项优化
# 修改配置使HPL走CBLAS接口，而不是老的Fortran BLAS
# 在配置文件中找到
HPL_DEFS     = $(F2CDEFS) $(HPL_OPTS) $(HPL_INCLUDES)
# 在这一行的上方加入以下内容
BLASLIB = -lopenblas
# 在末尾加上 -DHPL_CALL_CBLAS
HPL_DEFS     = $(F2CDEFS) $(HPL_OPTS) $(HPL_INCLUDES) -DHPL_CALL_CBLAS
# 找到CCFLAGS，添加-march=native
CCFLAGS      = $(HPL_DEFS) -fomit-frame-pointer -O3 -funroll-loops -W -Wall -march=native

# 默认的配置如下
LAdir        = $(HOME)/netlib/ARCHIVES/Linux_ATHLON
LAinc        =
LAlib        = $(LAdir)/libf77blas.a $(LAdir)/libatlas.a
# 修改为
LAdir   = /usr/lib64/openblas  # 或者你的 OpenBLAS 安装路径
LAinc   =
LAlib   = -lopenblas

# # 指定OpenMPI
# MPdir   = /usr
# MPinc   = -I/usr/include/openmpi-x86_64
# MPlib   = -L/usr/lib64 -lmpi

# 改为直接使用mpicc编译
# 修改CC
CC      = mpicc
# 在HPL_LIBS = $(HPLlib) $(LAlib) $(MPlib)的上方加入
MPlib = -lmpi
MPIinc = -I/usr/lib64/openmpi/include
MPilib = -L/usr/lib64/openmpi/lib -lmpi

# 复查一下系统中有没有openblas
ldconfig -p | grep openblas
# 输出通常如下所示
libopenblas64_.so.0 (libc6,x86-64) => /lib64/libopenblas64_.so.0
libopenblas64.so.0 (libc6,x86-64) => /lib64/libopenblas64.so.0
libopenblasp64_.so.0 (libc6,x86-64) => /lib64/libopenblasp64_.so.0
libopenblasp64.so.0 (libc6,x86-64) => /lib64/libopenblasp64.so.0
libopenblasp.so.0 (libc6,x86-64) => /lib64/libopenblasp.so.0
libopenblaso64_.so.0 (libc6,x86-64) => /lib64/libopenblaso64_.so.0
libopenblaso64.so.0 (libc6,x86-64) => /lib64/libopenblaso64.so.0
libopenblaso.so.0 (libc6,x86-64) => /lib64/libopenblaso.so.0
libopenblas.so.0 (libc6,x86-64) => /lib64/libopenblas.so.0

# 将g77指向gfortran
ln -s /usr/bin/gfortran /usr/bin/g77
# 编译HPL
make -f Make.top build_src arch=AMD_OpenBLAS
make -f Make.top build_tst arch=AMD_OpenBLAS


# 编辑HPL.dat
cd bin/AMD_OpenBLAS
mv HPL.dat HPL.dat.bak
vim HPL.dat

HPLinpack benchmark input file
Innovative Computing Laboratory, University of Tennessee
HPL.out
6
3            # of problems sizes (N)
160000 180000 200000  Ns
2            # of NBs
192 256      NBs
0            PMAP process mapping (0=Row-,1=Column-major)
4            # of process grids (P x Q)
8 12 16 24   Ps
12 8 6 4     Qs
16.0         threshold
3            # of panel fact
0 1 2        PFACTs (0=left, 1=Crout, 2=Right)
2            # of recursive stopping criterium
2 4          NBMINs (>= 1)
1            # of panels in recursion
2            NDIVs
3            # of recursive panel fact.
0 1 2        RFACTs (0=left, 1=Crout, 2=Right)
1            # of broadcast
1            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)
1            # of lookahead depth
1            DEPTHs (>=0)
2            SWAP (0=bin-exch,1=long,2=mix)
64           swapping threshold
0            L1 in (0=transposed,1=no-transposed) form
0            U  in (0=transposed,1=no-transposed) form
1            Equilibration (0=no,1=yes)
8            memory alignment in double (> 0)

# 禁用防火墙
systemctl stop firewalld
setenforce 0
# 开始运行
mpirun --allow-run-as-root -np 96 --map-by core --bind-to core ./xhpl

# 使用htop查看硬件负载
yum install -y htop
htop
```
