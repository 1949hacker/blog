---
title: NAS（zfs）基础知识
categories: [知识库]
date: 2024-04-02 13:01:57
keywords: 
    - NAS
    - ZFS
    - RAID
    - 存储
tags:
    - NAS
    - ZFS
    - RAID
    - 存储
---
## NAS是什么？

NAS，全称Network Attached Storage，翻译成中文就是网络附加存储。简单来说，它就是一个连接到网络上的存储设备，可以让多台电脑、智能手机、平板电脑等设备通过网络访问和共享存储空间。

<!-- more -->

NAS和传统的外接硬盘不同，它更像是一个小型的服务器，拥有自己的操作系统和处理器。你可以把NAS想象成一个能够存储大量文件的智能盒子，放在家里或者办公室的网络中，让你随时随地通过网络访问自己的文件。

使用NAS有很多好处。首先，它可以作为一个集中式的存储解决方案，让你不再需要把文件分散存储在各种设备上。其次，NAS通常具有数据备份和共享功能，可以保护你的文件免受丢失或损坏，并且可以让家人或团队成员轻松地共享文件。另外，NAS通常还提供了许多额外的功能，比如可以安装各种应用程序来扩展其功能，比如媒体服务器、下载站点等等。

总的来说，NAS就是一个连接到网络上的智能存储设备，可以让你方便地存储、备份和共享文件，是家庭和办公室网络存储的理想选择。

## NAS相对传统存储的优缺点

|优缺点|NAS|传统存储|
|---|---|---|
|容量|可以轻松扩展容量|通常受限于单个设备的容量|
|可访问性|可通过网络从任何地方访问文件|需要直接连接到设备才能访问文件|
|共享功能|能够方便地与多个用户共享文件|通常只能由一个用户使用|
|备份|提供自动备份和恢复功能|需要手动进行备份和恢复|
|数据保护|提供数据冗余和RAID功能，增强数据保护|数据保护功能通常有限|
|扩展性|可以安装各种应用程序扩展功能|功能受限于设备自身的硬件和软件功能|
|成本|初始成本较高，但长期使用成本较低|初始成本较低，但随着存储需求增长成本可能增加|
|管理复杂性|需要一定的网络和技术知识来配置和管理|简单易用，不需要复杂的配置和管理|

## NAS RAIDZ知识

YGENAS采用zfs文件系统，可以创建RAIDZ软磁盘阵列，对比传统磁盘阵列如下

|类型|zfs软RAID|传统RAID|特性|
|---|---|---|---|
|条带|Striping|RAID0|盘越多速度越快，安全性为0，掉盘则数据丢失|
|镜像|mirror|RAID1|安全性最高，传统RAID支持2个盘做镜像，一份数据存到2个盘上，软RAID则可以手动指定更多盘做镜像（通常没必要）|
|单重校验|RAID-Z1|RAID5|速度和安全性相对均衡，拥有1块校验盘所以可以允许单块盘故障|
|双重校验|RAID-Z2|RAID6|更偏向安全性，速度比单重校验略低，拥有3块校验盘所以可以允许2块盘故障|
|三重校验|RAID-Z3|无|软RAID特有，更安全但速度也低，拥有3块校验盘所以可以允许3块盘故障|
|组合RAID|可以将RAID1/5/6(RAID-Z3)，按条带方式组合，每个小RAID看作一块磁盘，如36盘分3组，每组12个盘做RAID5，最终组成RAID50，将12个为一组的RAID5看作一个大盘，这3个大盘做成一个RAID0|
|热备盘|无论是软RAID还是传统RAID，都可以添加热备盘，热备盘用于替换故障盘，在新YGENAS系统中热备盘会在掉盘时自动替换。实际应用中可以给客户解释：当RAID5出现故障盘时，若存在热备盘，则会自动第一时间替换掉故障盘，因为人工介入处理故障需要一定时间，热备盘的自动替换可以防止在人工换盘之前又出现故障盘，若RAID5同时故障两块盘则会丢失数据|

## NAS RAIDZ容量计算方法

[ZFS / RAIDZ容量估算](https://wintelguy.com/zfs-calc.pl)

|名称|作用|
|---|---|
|RAID type|RAID类型，对应上面介绍的RAID-Z1/2/3等|
|Drive capacity(GB)|单个磁盘容量，单位为GB，1TB=1000GB|
|Number of drives per RAID group|每组RAID中磁盘的数量，单组RAID-Z1/2/3均不建议超过12块盘，否则故障时重建时间过长可能存在风险|
|Number of RAID groups|多重RAID的数量，比如RAID50/60，该项则是对应多少组RAID5/6组成RAID50/60，比如36盘位通常由3组12盘的RAID-Z1组成一组RAID-Z1条带，也就是RAID50|
|20% free space limit|该参数是因为NAS在占用空间超过80%后性能会下降，所以会有一个20%空闲空间限制，但是该项默认是不勾选的，忽略即可|
|Practical usable storage capacity|实际可用存储容量，单位分别有TiB和TB，通常俗称的容量一般为TB，TiB是操作系统以1024GiB=1TiB为进制计算的空间|
|Single drive cost|单块硬盘价格，如果需要计算每TiB存储空间的成本，可以填写该项用于计算|
|Cost per TiB usable|每TiB存储空间成本|
|其他项在常见情况下也忽略即可|

以下是YGENAS-RH12按12个16TB硬盘做RAID-Z1的容量计算和成本计算（硬盘价格1600乱填的）：

![ad900b1ecf2520cd6c46787268124ed](https://img.hackerbs.com//ad900b1ecf2520cd6c46787268124ed.png)

![20240405190455](https://img.hackerbs.com//20240405190455.png)

## RAID-Z1/2/3速度估算

首先需要知道硬盘的官方数据用于参考，以公司常见的西数16TB WUH721816ALE6L4型号硬盘为例，在bing.com搜索到[西数官方数据](https://www.westerndigital.com/zh-cn/products/internal-drives/data-center-drives/ultrastar-dc-hc550-hdd?sku=0F38462)

![20240405191501](https://img.hackerbs.com//20240405191501.png)

这里采用官方的理论速度做为参考（**仅做为参考，实际速度没有任何人能准确计算，绝不可以此做为承诺**）

---

**注意，因为存储系统的复杂性，在此只能给出最最最简单的估算，该估算值为极限最优状态下的最高理论速度，严禁以此估算结果给用户承诺实际速度！！！**

影响NAS实际速度的部分因素有：

1. 单个硬盘速度
2. 磁盘阵列模式：奇偶校验、数据盘
3. 驱动器扇区大小
4. ZFS记录大小
5. 应用数据块大小
6. IO模式：异步/同步
7. IO队列深度
8. CPU、内存性能
9. 网络传输速度：NAS网卡速度，局域网链路速度，客户端网卡速度缺一不可，每一项短板都会限制实际速度
10. 客户端读写速度

---

简单估算速度的方法

n为单组阵列磁盘数量

|阵列类型|估算方法|12盘位示例|解释|
|---|---|---|---|
|RAID-Z1|单盘速度*(n-1)|262*(12-1)=2882MB/s|12个盘组成一个RAID5|
|RAID-Z2|单盘速度*(n-2)|262*(12-2)=2620MB/s|12个盘组成一个RAID6|
|RAID-Z3|单盘速度*(n-3)|262*(12-3)=2358MB/s|12个盘组成一个RAID7|
|RAID-Z10|单盘速度*(n-1)*磁盘组数量|262*(6-1)*2=2620MB/s|12个盘组成2个RAID5|
|RAID-Z20|单盘速度*(n-2)*磁盘组数量|262*(6-2)*2=2096MB/s|12个盘组成2个RAID6|
|RAID-Z30|单盘速度*(n-3)*磁盘组数量|262*(6-3)*2=1572MB/s|12个盘组成2个RAID7|

**以上计算方法仅可做为参考，因为实际使用环境的复杂性，做为参考给用户进行解释时，需将速度减半估计，如12个16TB盘（262MB/s）组单RAID-Z1，只可预估有1441MB/s速度，甚至更低，尤其是小文件（大量几KB，几MB的文件）传输时，速度会严重降低，属于正常现象。**